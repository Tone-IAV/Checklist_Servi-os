<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Editor de Hierarquia</title>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:20px;background:#f7fafc;color:#0f172a}
button{margin:4px;padding:6px 10px;border:1px solid #94a3b8;border-radius:6px;background:#fff;cursor:pointer}
button:hover{background:#e2e8f0}
table{border-collapse:collapse;margin-bottom:20px;width:100%}
th,td{border:1px solid #cbd5e1;padding:4px}
.board{display:flex;gap:10px;overflow:auto;padding-top:10px}
.col{background:#f1f5f9;padding:10px;border-radius:8px;min-width:200px}
.col-header{font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.col-header img{width:24px;height:24px;object-fit:contain;border-radius:4px}
.card{background:#fff;padding:6px;border-radius:4px;margin-bottom:6px;cursor:grab}
</style>
</head>
<body>
<div>
  <button id="view-planilha">Planilha</button>
  <button id="view-kanban">Kanban</button>
  <button id="btn-save">Salvar</button>
</div>
<div id="planilha"></div>
<div id="kanban" style="display:none"></div>
<script>
let DATA={sistemas:{headers:[],rows:[]},servicos:{headers:[],rows:[]},subsistemas:{headers:[],rows:[]}};
function fetchData(){
  google.script.run.withSuccessHandler(res=>{DATA=res; renderPlanilha(); renderKanban();}).getTables();
}
function renderPlanilha(){
  const cont=document.getElementById('planilha');
  cont.innerHTML='';
  for(const key of Object.keys(DATA)){
    const tableData=DATA[key];
    const headers=tableData.headers;
    const rows=tableData.rows;
    const section=document.createElement('section');
    section.innerHTML=`<h3>${key}</h3>`;
    const table=document.createElement('table');
    const thead=document.createElement('tr');
    headers.forEach(h=>{const th=document.createElement('th');th.textContent=h;thead.appendChild(th);});
    const thAct=document.createElement('th');thAct.textContent='Ações';thead.appendChild(thAct);
    table.appendChild(thead);
    rows.forEach((row,idx)=>{
      const tr=document.createElement('tr');
      headers.forEach(h=>{
        const keyLower=h.toLowerCase();
        const td=document.createElement('td');
        const input=document.createElement('input');
        input.value=row[keyLower]||'';
        input.addEventListener('input',e=>{row[keyLower]=e.target.value;if(key==='sistemas'&&keyLower==='icone'){img.src=e.target.value;}});
        td.appendChild(input);
        if(key==='sistemas' && keyLower==='icone'){
          const img=document.createElement('img');img.src=input.value;img.style.width='32px';img.style.height='32px';img.style.display='block';img.style.marginTop='4px';td.appendChild(img);
        }
        tr.appendChild(td);
      });
      const td=document.createElement('td');
      const del=document.createElement('button');del.textContent='Excluir';del.onclick=()=>{rows.splice(idx,1);renderPlanilha();};
      const dup=document.createElement('button');dup.textContent='Duplicar';dup.onclick=()=>{rows.splice(idx,0,JSON.parse(JSON.stringify(row)));renderPlanilha();};
      td.appendChild(del);td.appendChild(dup);tr.appendChild(td);table.appendChild(tr);
    });
    const addBtn=document.createElement('button');addBtn.textContent='Adicionar';addBtn.onclick=()=>{const obj={};headers.forEach(h=>obj[h.toLowerCase()]='');rows.push(obj);renderPlanilha();};
    section.appendChild(table);section.appendChild(addBtn);cont.appendChild(section);
  }
}
function renderKanban(){
  const cont=document.getElementById('kanban');
  cont.innerHTML='';
  const board=document.createElement('div');board.className='board';
  DATA.sistemas.rows.forEach(sys=>{
    const name=sys['sistema'];
    const col=document.createElement('div');col.className='col';col.dataset.sys=name;
    const header=document.createElement('div');header.className='col-header';
    const url=sys['icone'];if(url){const img=document.createElement('img');img.src=url;header.appendChild(img);}header.appendChild(document.createTextNode(name));
    col.appendChild(header);
    col.addEventListener('dragover',e=>e.preventDefault());
    col.addEventListener('drop',e=>{e.preventDefault();const idx=e.dataTransfer.getData('text/plain');DATA.subsistemas.rows[idx]['sistema']=name;renderKanban();});
    const list=document.createElement('div');col.appendChild(list);board.appendChild(col);
  });
  DATA.subsistemas.rows.forEach((sub,idx)=>{
    const sys=sub['sistema'];
    const col=board.querySelector(`.col[data-sys="${sys}"] div`);
    if(!col) return;
    const card=document.createElement('div');card.className='card';card.draggable=true;
    const titulo=sub['subsistemas']||sub['subsistema'];
    const comp=sub['componentes']||sub['componente']||'';
    card.textContent=titulo+(comp?` - ${comp}`:'');
    card.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',idx));
    col.appendChild(card);
  });
  cont.appendChild(board);
}
document.getElementById('view-planilha').onclick=()=>{document.getElementById('planilha').style.display='block';document.getElementById('kanban').style.display='none';};
document.getElementById('view-kanban').onclick=()=>{document.getElementById('planilha').style.display='none';document.getElementById('kanban').style.display='block';renderKanban();};
document.getElementById('btn-save').onclick=()=>{google.script.run.withSuccessHandler(()=>alert('Salvo')).saveTables(DATA);};
fetchData();
</script>
</body>
</html>
