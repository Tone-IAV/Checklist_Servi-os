<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Editor de Hierarquia</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
<?!= HtmlService.createHtmlOutputFromFile("Styles").getContent(); ?>
<style>
  .topbar{display:flex;gap:8px;margin-bottom:12px}
  .btn.small{padding:8px 14px;font-size:1rem}
  table{width:100%;border-collapse:collapse;margin-bottom:16px;font-size:1rem}
  th,td{border:1px solid var(--line);padding:6px 8px}
  tr:hover{background:#f1f5f9}
  td.actions{width:60px}
  td.actions .act{display:none;background:none;border:none;cursor:pointer;color:var(--muted)}
  tr:hover td.actions .act{display:inline-flex}
  .board{display:flex;gap:12px;overflow-x:auto;height:calc(100vh - 120px);padding:10px 0}
  .col{background:var(--card);border:1px solid var(--line);border-radius:8px;min-width:220px;display:flex;flex-direction:column}
  .col-header{padding:8px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px;font-weight:600}
  .col-header img{width:24px;height:24px;object-fit:contain;border-radius:4px}
  .card{background:#fff;border:1px solid var(--line);border-radius:6px;padding:8px;margin:8px;cursor:grab;position:relative}
  .card .actions{position:absolute;top:4px;right:4px;display:none;gap:4px}
  .card:hover .actions{display:flex}
  .card .actions button{background:none;border:none;cursor:pointer;color:var(--muted)}
  .card .actions button:hover{color:var(--primary)}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <button id="view-planilha" class="btn small">Planilha</button>
    <button id="view-kanban" class="btn small">Kanban</button>
    <button id="btn-save" class="btn primary small" style="margin-left:auto">Salvar</button>
  </div>
  <div id="planilha"></div>
  <div id="kanban" style="display:none"></div>
</div>
<script>
let DATA={sistemas:{headers:[],rows:[]},servicos:{headers:[],rows:[]},subsistemas:{headers:[],rows:[]}};
function fetchData(){
  google.script.run.withSuccessHandler(res=>{DATA=res; renderPlanilha(); renderKanban();}).getTables();
}
function renderPlanilha(){
  const cont=document.getElementById('planilha');
  cont.innerHTML='';
  for(const key of Object.keys(DATA)){
    const tableData=DATA[key];
    const headers=tableData.headers;
    const rows=tableData.rows;
    const section=document.createElement('section');
    section.innerHTML=`<h3>${key}</h3>`;
    const table=document.createElement('table');
    const thead=document.createElement('tr');
    headers.forEach(h=>{
      const th=document.createElement('th');th.textContent=h;thead.appendChild(th);
    });
    const thAct=document.createElement('th');thAct.textContent='';thead.appendChild(thAct);
    table.appendChild(thead);
    rows.forEach((row,idx)=>{
      const tr=document.createElement('tr');
      headers.forEach(h=>{
        const keyLower=h.toLowerCase();
        const td=document.createElement('td');
        const input=document.createElement('input');
        input.value=row[keyLower]||'';
        input.addEventListener('input',e=>{
          row[keyLower]=e.target.value;
          renderKanban();
        });
        td.appendChild(input);
        if(key==='sistemas' && keyLower==='icone'){
          const img=document.createElement('img');
          img.src=input.value;
          img.style.width='32px';img.style.height='32px';img.style.display='block';img.style.marginTop='4px';
          input.addEventListener('input',e=>{img.src=e.target.value;});
          td.appendChild(img);
        }
        tr.appendChild(td);
      });
      const td=document.createElement('td');td.className='actions';
      const dup=document.createElement('button');dup.textContent='⧉';dup.className='act';dup.onclick=()=>{rows.splice(idx+1,0,JSON.parse(JSON.stringify(row)));renderPlanilha();renderKanban();};
      const del=document.createElement('button');del.textContent='✕';del.className='act';del.onclick=()=>{rows.splice(idx,1);renderPlanilha();renderKanban();};
      td.appendChild(dup);td.appendChild(del);tr.appendChild(td);table.appendChild(tr);
    });
    const addBtn=document.createElement('button');addBtn.className='btn small';addBtn.textContent='Adicionar';addBtn.onclick=()=>{const obj={};headers.forEach(h=>obj[h.toLowerCase()]='');rows.push(obj);renderPlanilha();renderKanban();};
    section.appendChild(table);section.appendChild(addBtn);cont.appendChild(section);
  }
}
function renderKanban(){
  const cont=document.getElementById('kanban');
  cont.innerHTML='';
  const board=document.createElement('div');board.className='board';
  DATA.sistemas.rows.forEach(sys=>{
    const name=sys['sistema'];
    const col=document.createElement('div');col.className='col';col.dataset.sys=name;
    const header=document.createElement('div');header.className='col-header';
    const url=sys['icone'];if(url){const img=document.createElement('img');img.src=url;header.appendChild(img);}
    header.appendChild(document.createTextNode(name));
    col.appendChild(header);
    col.addEventListener('dragover',e=>e.preventDefault());
    col.addEventListener('drop',e=>{e.preventDefault();const idx=e.dataTransfer.getData('text/plain');DATA.subsistemas.rows[idx]['sistema']=name;renderKanban();renderPlanilha();});
    const list=document.createElement('div');list.className='list';col.appendChild(list);board.appendChild(col);
  });
  DATA.subsistemas.rows.forEach((sub,idx)=>{
    const sys=sub['sistema'];
    const list=board.querySelector(`.col[data-sys="${sys}"] .list`);
    if(!list) return;
    const card=document.createElement('div');card.className='card';card.draggable=true;
    const titulo=sub['subsistemas']||sub['subsistema'];
    const comp=sub['componentes']||sub['componente']||'';
    card.textContent=titulo+(comp?` - ${comp}`:'');
    card.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',idx));
    const actions=document.createElement('div');actions.className='actions';
    const dup=document.createElement('button');dup.textContent='⧉';dup.onclick=()=>{DATA.subsistemas.rows.splice(idx+1,0,JSON.parse(JSON.stringify(sub)));renderKanban();renderPlanilha();};
    const del=document.createElement('button');del.textContent='✕';del.onclick=()=>{DATA.subsistemas.rows.splice(idx,1);renderKanban();renderPlanilha();};
    actions.appendChild(dup);actions.appendChild(del);card.appendChild(actions);
    list.appendChild(card);
  });
  cont.appendChild(board);
}
document.getElementById('view-planilha').onclick=()=>{document.getElementById('planilha').style.display='block';document.getElementById('kanban').style.display='none';};
document.getElementById('view-kanban').onclick=()=>{document.getElementById('planilha').style.display='none';document.getElementById('kanban').style.display='block';renderKanban();};
document.getElementById('btn-save').onclick=()=>{google.script.run.withSuccessHandler(()=>alert('Salvo')).saveTables(DATA);};
fetchData();
</script>
</body>
</html>
