<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OS Automotiva ‚Äî Sele√ß√£o Visual</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
<style>
  :root{
    --bg:#f7fafc; --text:#0f172a; --muted:#64748b; --line:#e2e8f0; --card:#ffffff;
    --primary:#2563eb; --primary-2:#60a5fa; --ok:#16a34a; --warn:#d97706; --bad:#ef4444;
    --mech:#3b82f6; --safe:#f97316; --comfort:#16a34a;
    --radius:14px;
    font-size:22px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:1rem/1.5 Inter, system-ui, Segoe UI, Roboto, Arial}
  .wrap{width:100%;max-width:none;margin:0;padding:16px}
  header{display:flex;flex-wrap:wrap;align-items:center;gap:10px;margin-bottom:14px}
  header h1{font-size:2rem;margin:0}
  .badge{background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#fff;padding:8px 12px;border-radius:999px;font-weight:700}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:1rem}
  .mini{font-size:1rem;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:14px;margin-bottom:14px}
  .section-title{margin:0 0 10px 0;font-weight:700}
  .grid{display:grid;gap:10px}
  .g2{grid-template-columns: repeat(2, minmax(0,1fr))}
  .g3{grid-template-columns: repeat(3, minmax(0,1fr))}
  .g4{grid-template-columns: repeat(4, minmax(0,1fr))}
  label{font-size:1rem;color:var(--muted);display:block;margin-bottom:6px}
  input, select, textarea{
    width:100%;background:#fff;border:1px solid #dbe6f1;color:var(--text);
    border-radius:12px;padding:14px 16px;outline:none;transition:.2s;
  }
  input:focus, select:focus, textarea:focus{border-color:#93c5fd; box-shadow:0 0 0 3px #93c5fd55}
  input[readonly]{background:#f8fafc;color:var(--muted);cursor:not-allowed}
  textarea{min-height:80px;resize:vertical}
  .btn{display:inline-flex;align-items:center;gap:8px;background:#f1f5f9;border:1px solid #dbe6f1;color:#0f172a;padding:18px 24px;border-radius:12px;cursor:pointer;font-size:1.2rem}
  .btn:hover{background:#e9eef5}
  .btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#fff;border-color:transparent}
  .btn.ghost{background:#fff}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px}
  .divider{height:1px;background:var(--line);margin:12px 0}
  .items-head, .item-row{display:grid;grid-template-columns:1.1fr 1.1fr 1.2fr 0.8fr 1.1fr 1.3fr 0.7fr 0.8fr 1fr 0.6fr;gap:8px}
  .items-head{font-size:1rem;color:var(--muted);margin-bottom:6px}
  .item-row{margin-bottom:8px}
  .item-actions{display:flex;gap:6px}
  .totals{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
  .kpi{background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px}
  .kpi .k{font-size:1rem;color:var(--muted)}
  .kpi .v{font-weight:700}
  /* --------- Sele√ß√£o Visual (cards) --------- */
  .tiles{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .tile{
    --accent:var(--primary);
    position:relative;display:flex;flex-direction:column;align-items:flex-start;gap:18px;cursor:pointer;
    background:linear-gradient(145deg,#ffffff,#f3f7fb);padding:22px;border-radius:22px;min-height:190px;
    box-shadow:0 18px 40px rgba(15,23,42,.08);border:none;transition:transform .2s ease, box-shadow .2s ease;
    overflow:hidden;
  }
  .tile::after{
    content:"";position:absolute;top:0;right:0;width:22px;height:100%;
    background:linear-gradient(180deg,var(--accent),rgba(255,255,255,0));opacity:.85;
  }
  .tile::before{
    content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,.35),transparent);
    pointer-events:none;
  }
  .tile:hover{transform:translateY(-6px);box-shadow:0 26px 55px rgba(15,23,42,.12)}
  .tile:focus-visible{outline:3px solid rgba(37,99,235,.35);outline-offset:4px}
  @keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:none}}
  .tile-top{width:100%;display:flex;justify-content:space-between;align-items:flex-start;position:relative;z-index:1}
  .tile-number{
    display:inline-flex;align-items:center;justify-content:center;padding:6px 12px;border-radius:14px;font-weight:700;
    font-size:1rem;color:#fff;background:var(--accent);box-shadow:0 8px 20px rgba(15,23,42,.15);
  }
  .tile .icon{
    position:relative;z-index:1;width:72px;height:72px;border-radius:20px;display:grid;place-items:center;font-size:2rem;
    background:rgba(37,99,235,.08);color:var(--accent);overflow:hidden;
  }
  .tile .icon img{width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 6px 10px rgba(15,23,42,.15));}
  .tile .icon span{font-weight:700;font-size:1.4rem;}
  .tile-body{position:relative;z-index:1;display:flex;flex-direction:column;gap:8px;width:100%;flex:1}
  .tile .title{font-weight:700;font-size:1.05rem}
  .tile .hint{font-size:.95rem;color:var(--muted)}
  .tile .sub-inputs{display:none;margin-top:8px;width:100%}
  .tile .sub-inputs input{width:100%;border:1px solid #dbe6f1;border-radius:12px;padding:10px 12px;font-size:1rem}
  .tile.cat-mech{--accent:var(--mech)}
  .tile.cat-safe{--accent:var(--safe)}
  .tile.cat-comfort{--accent:var(--comfort)}
  .tile.cat-mech .icon{background:rgba(59,130,246,.12)}
  .tile.cat-safe .icon{background:rgba(249,115,22,.12)}
  .tile.cat-comfort .icon{background:rgba(22,163,74,.12)}
  .tile.active{transform:translateY(-8px);box-shadow:0 30px 60px rgba(37,99,235,.18);background:linear-gradient(145deg,#f5f9ff,#e6efff)}
  .tile.active::after{width:28px}
  .tile.active .tile-number{box-shadow:0 10px 24px rgba(37,99,235,.2)}
  .tile.active .sub-inputs{display:block;animation:fadeIn .2s ease}
  .row-actions{display:flex;gap:8px;flex-wrap:wrap}
  .search{display:flex;gap:8px;align-items:center}
  .search input{flex:1}
  .list-panel{border:1px dashed #cbd5e1;border-radius:12px;padding:10px;background:#fbfeff;max-height:none;overflow:visible}
  .comp-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .comp{display:flex;align-items:center;gap:14px;border:2px solid #e2e8f0;border-radius:14px;padding:18px;min-height:120px;background:#fff;cursor:pointer}
  .comp:hover{border-color:#93c5fd}
  .comp .icon{width:64px;height:64px;border-radius:10px;display:grid;place-items:center;background:#f4f7ff;border:1px solid #dbe6f1}
  .comp .inputs{display:none;gap:8px;margin-top:6px;flex-wrap:wrap}
  .comp.selected .inputs{display:flex;animation:fadeIn .2s ease}
  .comp .inputs input{flex:1;border:1px solid #dbe6f1;border-radius:8px;padding:6px}
  .comp .inputs input.qtd{flex:0 0 60px}
  .comp .inputs input.val{flex:0 0 80px}
  .comp .hint{font-size:1rem;color:var(--muted)}
  .actions{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
  .action-btn{flex:0 0 auto;background:#fff;border:2px solid #e2e8f0;border-radius:12px;padding:8px 14px;font-size:1rem;cursor:pointer;transition:.2s}
  .action-btn:hover{border-color:var(--primary);color:var(--primary)}
  .action-btn.active{background:var(--primary);border-color:var(--primary);color:#fff}
  .comp.selected{border-color:var(--primary)}
  .comp.acao-reparo{border-color:var(--warn)}
  .comp.acao-troca{border-color:var(--bad)}
  .footer-note{font-size:1rem;color:var(--muted)}
  @media (max-width:900px){
    .tiles{grid-template-columns:1fr 1fr}
    .comp-grid{grid-template-columns:1fr}
    .items-head, .item-row{grid-template-columns:1fr 1fr 1fr 0.9fr 1.2fr 1fr 0.7fr 0.9fr 1fr 0.6fr}
  }
  @media (max-width:600px){
    .tiles{grid-template-columns:1fr}
    .wrap{padding:8px}
    .card{border:none;border-radius:0;padding:14px 0;margin-bottom:10px}
  }
  @media print{ .btn, .toolbar, .list-panel, .tiles, .row-actions, .search{display:none !important} }
</style>
</head>
<body>
<div class="wrap">
  <!-- DADOS B√ÅSICOS -->
  <div class="card">
    <h3 class="section-title">Dados</h3>
    <input type="hidden" id="f-os" />
    <div class="grid g2">
      <div><label>Entrada</label><input id="f-data-entrada" readonly/></div>
      <div><label>Oficina</label><input id="f-resp" placeholder="Nome da oficina"/></div>
    </div>
    <div class="grid g4" style="margin-top:8px">
      <div>
        <label>Placa</label>
        <select id="f-placa">
          <option value="">Selecione a placa</option>
        </select>
      </div>
      <div><label>Ve√≠culo</label><input id="f-veiculo" readonly/></div>
      <div><label>Ano/Modelo</label><input id="f-ano-modelo" readonly/></div>
      <div><label>Motorista</label><input id="f-motorista" readonly/></div>
    </div>
    <div id="hist" class="mini"></div>
  </div>

  <!-- ADICIONADOR VISUAL ‚Äî PASSO A PASSO -->
  <div class="card">
    <h3 class="section-title">Adicionar itens (visual e em lote)</h3>

    <!-- Passo 1: Sistemas -->
    <label>1) Escolha o <b>Sistema</b></label>
    <div id="tiles-sistemas" class="tiles" aria-label="Sistemas"></div>
    <div class="row-actions">
      <button id="btn-export-hier" class="btn">Exportar Sistemas</button>
      <button id="btn-import-hier" class="btn">Importar Sistemas</button>
      <input type="file" id="file-hier" accept="application/json" style="display:none" />
    </div>

    <!-- Passo 2: SubSistemas -->
    <div class="divider"></div>
    <div class="row-actions">
      <div class="search" style="flex:1">
        <label style="margin:0;color:var(--muted)">2) Selecione SubSistema</label>
        <input id="filtroSub" placeholder="Buscar SubSistemas‚Ä¶" />
      </div>
    </div>
    <div id="panel-subs" class="list-panel">
      <div id="subs" class="tiles"></div>
    </div>

    <!-- Passo 3: Componentes -->
    <div class="divider"></div>
    <div class="row-actions">
      <div class="search" style="flex:1">
        <label style="margin:0;color:var(--muted)">3) Selecione Componente</label>
        <input id="filtroComp" placeholder="Buscar Componentes‚Ä¶ (ex.: pastilha, correia)" />
      </div>
    </div>
    <div id="panel-comps" class="list-panel">
      <div id="comps" class="comp-grid"></div>
    </div>

    <!-- Op√ß√µes & Pr√©via -->
    <div class="divider"></div>
    <div class="toolbar" style="justify-content:flex-end">
      <button class="btn" id="btn-pdf">Exportar PDF</button>
      <button class="btn" id="btn-finalizar">Finalizar checklist</button>
      <button class="btn primary" id="btn-add-batch">Adicionar itens</button>
    </div>
  </div>

  <!-- ITENS LAN√áADOS (oculto) -->
  <div class="card" id="itemsCard" style="display:none">
    <div class="toolbar" style="justify-content:space-between;align-items:center">
      <h3 class="section-title" style="margin:0">Itens da OS</h3>
      <div class="toolbar">
        <button class="btn" id="btn-add">+ Linha vazia</button>
        <button class="btn" id="btn-export">Exportar CSV</button>
        <button class="btn" id="btn-save">Salvar JSON</button>
        <button class="btn" id="btn-load">Carregar JSON</button>
      </div>
    </div>

    <div class="items-head">
      <div>Sistema</div><div>SubSistema</div><div>Componente</div>
      <div>Tipo</div><div>Servi√ßo</div><div>Descri√ß√£o/Peculiaridade</div>
      <div>Qtd</div><div>Un</div><div>Pre√ßo (R$)</div><div></div>
    </div>
    <div id="items"></div>

    <div class="divider"></div>
    <div class="totals">
      <div class="kpi"><div class="k">Total Pe√ßas</div><div class="v" id="t-pecas">R$ 0,00</div></div>
      <div class="kpi"><div class="k">Total Servi√ßos</div><div class="v" id="t-serv">R$ 0,00</div></div>
      <div class="kpi"><div class="k">Acr√©scimos (R$)</div><input id="t-acresc" type="number" step="0.01" value="0"/></div>
      <div class="kpi"><div class="k">Total Geral</div><div class="v" id="t-geral">R$ 0,00</div></div>
    </div>
  </div>

  <div class="mini">Arquivo local. As imagens de refer√™ncia foram mostradas acima para orientar a sele√ß√£o (n√£o s√£o baixadas pelo formul√°rio).</div>

  <div class="card" id="sugestoes" style="display:none">
    <h3 class="section-title">Sugest√µes</h3>
    <ul id="sug-list"></ul>
  </div>
</div>

<script>
/* ======= Cat√°logo (igual ao seu) ======= */
const HIERARQUIA = {
  "Motor": {"Alimenta√ß√£o (Ar & Combust√≠vel)":[
      "Filtro de ar","Corpo de borboleta","Bicos injetores","Bomba de combust√≠vel","Filtro de combust√≠vel",
      "Linha de combust√≠vel","Coletor de admiss√£o","Sensor MAP","Sensor MAF","Regulador de press√£o"
    ],
    "Igni√ß√£o":["Velas de igni√ß√£o","Cabos de vela","Bobina(s) de igni√ß√£o","M√≥dulo de igni√ß√£o"],
    "Lubrifica√ß√£o":["√ìleo do motor","Filtro de √≥leo","C√°rter","V√°lvula PCV","Junta do c√°rter","Retentores"],
    "Arrefecimento":["Radiador","Ventoinha/ventilador","Bomba d'√°gua","V√°lvula termost√°tica","Reservat√≥rio de expans√£o","Tampa do radiador/reservat√≥rio","Mangueiras de √°gua","Sensor de temperatura","Junta do cabe√ßote"],
    "Correias & Comando":["Correia dentada","Corrente de comando","Tensor/Esticador","Polias","Correia de acess√≥rios"],
    "Escape":["Coletor de escape","Catalisador","Sonda lambda (pr√©/p√≥s)","Silencioso intermedi√°rio","Silencioso traseiro","Junta de escape"],
    "Veda√ß√£o":["Junta da tampa de v√°lvulas","Retentor do virabrequim (dianteiro/traseiro)","Juntas diversas"]
  },
  "Transmiss√£o/Tra√ß√£o":{"Embreagem (Manual)":["Kit embreagem (disco/plat√¥/rolamento)","Cilindro mestre","Cilindro escravo","Cabo de embreagem"],
    "C√¢mbio (Manual/Automatizado/Autom√°tico/CVT)":["√ìleo do c√¢mbio","Trambulador/linkagem","Retentores do c√¢mbio"],
    "Semieixos/Homocin√©ticas":["Semieixo","Junta homocin√©tica","Coifa homocin√©tica"],
    "Diferencial/Transfer√™ncia":["√ìleo do diferencial","Caixa de transfer√™ncia (4x4)"]
  },
  "Dire√ß√£o":{"Coluna de dire√ß√£o":["Junta cardan da coluna","Trava do volante"],
    "Caixa/cremalheira":["Caixa de dire√ß√£o","Coifas/guarda-p√≥s","Buchas da caixa","Bomba de dire√ß√£o (hidr√°ulica)","Motor el√©trico (EPS)"],
    "Barras & Terminais":["Barra axial","Terminal de dire√ß√£o","Bra√ßo pitman (onde aplic√°vel)"]
  },
  "Suspens√£o":{"Dianteira":["Amortecedor dianteiro","Mola helicoidal dianteira","Coxim/rolamento do amortecedor","Bandeja/bras oscilante","Bucha da bandeja","Piv√¥ de suspens√£o","Bieleta","Barra estabilizadora","Buchas da barra estabilizadora","Rolamento de roda dianteiro"],
    "Traseira":["Amortecedor traseiro","Mola traseira","Coxim traseiro","Buchas traseiras","Feixe de molas (utilit√°rios)","Bra√ßos/tirantes","Rolamento de roda traseiro"]
  },
  "Freios":{"Dianteiro":["Pastilhas de freio dianteiras","Discos de freio dianteiros","Pin√ßa de freio dianteira","Flex√≠vel de freio dianteiro"],
    "Traseiro":["Lonas de freio","Tambor de freio","Cilindro de roda","Pin√ßa traseira (se disco)","Discos traseiros (se aplic√°vel)","Flex√≠vel de freio traseiro"],
    "Hidr√°ulico/Sistema":["Fluido de freio","Cilindro mestre","Servo-freio (hidrov√°cuo)","V√°lvula proporcional/reguladora"],
    "ABS/Estabilidade":["M√≥dulo ABS/ESP","Sensor de roda ABS","Anel reluctor"]
  },
  "Pneus & Rodas":{"Conjunto":["Pneu","Roda","V√°lvula","Calota","Estepe","Parafusos/porcas de roda","Cubo de roda"]},
  "El√©trica/Eletr√¥nica":{"Carga & Partida":["Bateria","Alternador","Motor de partida","Cabos/terminais de bateria"],
    "Ilumina√ß√£o/Sinaliza√ß√£o":["Far√≥is (conjunto/l√¢mpadas)","Lanternas traseiras","DRL","Luzes de freio","Setas/indicadores","Neblina"],
    "Chicote & Prote√ß√£o":["Chicote el√©trico","Fus√≠veis","Rel√©s","Caixa de fus√≠veis"],
    "Sensores & Atuadores":["Sensor TPS","Sensor ECT (temperatura do motor)","Sensor CKP (rota√ß√£o)","Sensor CMP (fase)","Atuador de marcha lenta"],
    "M√≥dulos/Computadores":["ECU do motor","TCU do c√¢mbio","BCM","M√≥dulo ABS","M√≥dulo Airbag","Conector OBD"]
  },
  "Ar-Condicionado/Climatiza√ß√£o":{"Sistema de A/C":["Compressor","Condensador","Evaporador","V√°lvula de expans√£o/orif√≠cio","Filtro secador","Filtro de cabine","Motor do ventilador interno","Pressostatos/sensores","G√°s refrigerante & √≥leo do A/C"]},
  "Carroceria & Fechaduras":{"Aberturas & Veda√ß√£o":["Cap√¥","Trava do cap√¥","Portas","Porta-malas","Ma√ßanetas","Dobradi√ßas","Borrachas de veda√ß√£o"],
    "Vidros & Acionamentos":["Para-brisa","Vidros laterais","Regulador de vidro (el√©trico/manual)","Travas el√©tricas","Retrovisores (espelho/motor)"],
    "Externo":["Para-choques","Para-lamas","Frisos/defletores","Protetor de c√°rter"],
    "Limpeza de Vidros":["Palhetas do limpador","Reservat√≥rio do limpador","Motor da bomba do limpador"]
  },
  "Seguran√ßa & Itens obrigat√≥rios":{"Sistemas":["Cintos de seguran√ßa","Airbags","Sensores de colis√£o","ABS/ESP"],
    "Itens de emerg√™ncia":["Tri√¢ngulo","Macaco","Chave de roda","Kit de primeiros socorros (quando aplic√°vel)"]
  },
  "Documenta√ß√£o & Acess√≥rios":{"Documentos & Itens":["CRLV-e (licenciamento)","Manual do propriet√°rio","Chave reserva"],
    "Acess√≥rios":["R√°dio/central multim√≠dia","Alto-falantes","Alarme","Rastreador","Engate","Calhas de chuva","Sensor de estacionamento","C√¢mera de r√©"]
  },
  "Diagn√≥stico & Testes":{"Procedimentos":["Scanner OBD (leitura/limpeza de DTCs)","Teste de compress√£o","Teste de fuga de CO‚ÇÇ no arrefecimento","Teste de press√£o de combust√≠vel","Teste de carga/partida","Vaz√£o de bicos injetores","Alinhamento 3D","Balanceamento de rodas","Teste de rodagem"]}
};
const SERVICOS = ["Inspe√ß√£o visual","Teste funcional","Diagn√≥stico com scanner","Leitura/limpeza de DTC","Limpeza/descarboniza√ß√£o","Ajuste/Calibra√ß√£o","Troca/Substitui√ß√£o","Reparo/Recondicionamento","Lubrifica√ß√£o","Reaperto/Torque","Sangria (freio/embreagem)","Alinhamento","Balanceamento","Regulagem de far√≥is","Recarga (bateria/A.C.)","Atualiza√ß√£o de software","Regenera√ß√£o DPF (diesel)","Veda√ß√£o/Aplica√ß√£o de junta/cola","Higieniza√ß√£o do A.C.","Teste de rodagem/valida√ß√£o"];

const SYS_CAT = {
  "Motor":"mech",
  "Transmiss√£o/Tra√ß√£o":"mech",
  "Suspens√£o":"mech",
  "Carroceria & Fechaduras":"mech",
  "Diagn√≥stico & Testes":"mech",
  "Dire√ß√£o":"safe",
  "Freios":"safe",
  "Pneus & Rodas":"safe",
  "Seguran√ßa & Itens obrigat√≥rios":"safe",
  "Ar-Condicionado/Climatiza√ß√£o":"comfort",
  "El√©trica/Eletr√¥nica":"comfort",
  "Documenta√ß√£o & Acess√≥rios":"comfort"
};

const CHECKLIST = {};
let VEHICLES = [];
let CURRENT_VEHICLE = null;
let PENDING_VEHICLE_PLATE = null;
let CURRENT_STATUS = 'Aberta';

/* ======= Utils ======= */
const fmtBRL = v => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);
const toNumber = el => { const n = parseFloat(String(el?.value||"").replace(",",".")); return isFinite(n)?n:0; };
function el(tag, attrs={}, ...children){ const e=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>{ if(k==='class')e.className=v; else if(k==='html')e.innerHTML=v; else e.setAttribute(k,v); }); children.forEach(c=>e.append(c)); return e; }

/* ======= Entrada autom√°tica ======= */
function setEntrada(isoValue='', displayValue=''){
  const input = document.getElementById('f-data-entrada');
  if(!input) return;
  let iso = isoValue || '';
  let display = displayValue || '';
  if(!display && iso){
    const parsed = new Date(iso);
    display = isNaN(parsed) ? iso : parsed.toLocaleString('pt-BR');
  }
  if(!iso && display){
    const parsed = new Date(display);
    iso = isNaN(parsed) ? display : parsed.toISOString();
  }
  input.value = display;
  input.dataset.iso = iso || display || '';
}
function setEntradaNow(){
  const now = new Date();
  setEntrada(now.toISOString(), now.toLocaleString('pt-BR'));
}

/* ======= √çcones com imagens por Sistema ======= */
const SYS_ICON_LINKS = {
  "Motor":"https://cdn-icons-png.flaticon.com/128/2061/2061956.png",
  "Transmiss√£o/Tra√ß√£o":"https://cdn-icons-png.flaticon.com/128/2783/2783760.png",
  "Dire√ß√£o":"https://cdn-icons-png.flaticon.com/128/4869/4869033.png",
  "Suspens√£o":"https://cdn-icons-png.flaticon.com/128/4539/4539880.png",
  "Freios":"https://cdn-icons-png.flaticon.com/128/662/662877.png",
  "Pneus & Rodas":"https://cdn-icons-png.flaticon.com/128/1768/1768143.png",
  "El√©trica/Eletr√¥nica":"https://cdn-icons-png.flaticon.com/128/649/649797.png",
  "Ar-Condicionado/Climatiza√ß√£o":"https://cdn-icons-png.flaticon.com/128/18208/18208239.png",
  "Carroceria & Fechaduras":"https://cdn-icons-png.flaticon.com/128/6246/6246180.png",
  "Seguran√ßa & Itens obrigat√≥rios":"https://cdn-icons-png.flaticon.com/128/1039/1039155.png",
  "Diagn√≥stico & Testes":"https://cdn-icons-png.flaticon.com/128/2631/2631398.png"
};
function sysIcon(name){
  const url = SYS_ICON_LINKS[name];
  if(url){
    const safeAlt = (name || '').replace(/"/g,'&quot;');
    return `<img src="${url}" alt="${safeAlt}" loading="lazy"/>`;
  }
  const letter = String(name||'').trim().charAt(0) || '?';
  return `<span>${letter}</span>`;
}

/* ======= Sele√ß√£o Visual ======= */
const tilesSistemas = document.getElementById('tiles-sistemas');
const subsBox = document.getElementById('subs');
const compsBox = document.getElementById('comps');
const filtroSub = document.getElementById('filtroSub');
const filtroComp = document.getElementById('filtroComp');

let SYS = null;
const SUBS = new Set();
function renderSistemas(){
  tilesSistemas.innerHTML='';
  Object.keys(HIERARQUIA).forEach((sys, idx)=>{
    const cat = SYS_CAT[sys] || 'mech';
    const t = el('div',{class:`tile cat-${cat}`, tabindex:"0", role:"button", 'data-sys':sys});
    t.innerHTML = `<div class="tile-top">
                     <span class="tile-number">${idx+1}</span>
                     <div class="icon">${sysIcon(sys)}</div>
                   </div>
                   <div class="tile-body">
                     <div class="title">${sys}</div>
                     <div class="hint">Clique para selecionar</div>
                   </div>`;
    t.addEventListener('click', ()=>selectSistema(sys,t));
    t.addEventListener('keypress', e=>{ if(e.key==='Enter'||e.key===' ') selectSistema(sys,t); });
    tilesSistemas.appendChild(t);
  });
}
function selectSistema(sys, tile){
  if(SYS === sys){
    if(confirm('Tem certeza que deseja desmarcar o item e subitens?')){
      SYS = null;
      SUBS.clear();
      [...tilesSistemas.children].forEach(c=>{ c.classList.remove('active'); c.style.display=''; });
      renderSubSistemas();
      renderComponentes();
    }
    return;
  }
  SYS = sys;
  SUBS.clear();
  if(CHECKLIST[sys]){
    Object.keys(CHECKLIST[sys]).forEach(sub=>SUBS.add(sub));
  }
  [...tilesSistemas.children].forEach(c=>{
    c.classList.remove('active');
    if(c !== tile) c.style.display='none';
  });
  tile.style.display='';
  tile.classList.add('active');
  renderSubSistemas();
  renderComponentes();
}
function renderSubSistemas(){
  subsBox.innerHTML='';
  if(!SYS) return;
  const subs = Object.keys(HIERARQUIA[SYS]);
  subs.forEach((sub, idx)=>{
    const t = el('div',{class:'tile', tabindex:"0", role:"button", 'data-sub':sub});
    t.innerHTML = `<div class="tile-top">
                     <span class="tile-number">${idx+1}</span>
                     <div class="icon">${sysIcon(SYS)}</div>
                   </div>
                   <div class="tile-body">
                     <div class="title">${sub}</div>
                     <div class="hint">Clique para selecionar</div>
                     <div class="sub-inputs"><input type="number" class="sub-val" placeholder="Valor" value="0"></div>
                   </div>`;
    if(SUBS.has(sub)) t.classList.add('active');
    function toggle(){
      if(SUBS.has(sub)){
        SUBS.delete(sub);
        t.classList.remove('active');
      }else{
        SUBS.add(sub);
        t.classList.add('active');
      }
      renderComponentes();
    }
    t.addEventListener('click', e=>{ if(e.target.closest('.sub-inputs')) return; toggle(); });
    t.addEventListener('keypress', e=>{ if(e.key==='Enter'||e.key===' ') toggle(); });
    subsBox.appendChild(t);
  });
  applyFilterSub();
}
function renderComponentes(){
  compsBox.innerHTML='';
  if(!SYS || SUBS.size===0) return;
  SUBS.forEach(sub=>{
    (HIERARQUIA[SYS][sub]||[]).forEach(comp=>{
      const key = `${SYS}__${sub}__${comp}`;
      const c = el('div',{class:'comp', 'data-comp':comp, 'data-sub':sub, 'data-key':key, 'data-sys':SYS});
      c.innerHTML = `<div class="icon">${sysIcon(SYS)}</div>
                     <div style="flex:1"><div class="title">${comp}</div>
                     <div class="hint">${sub}</div>
                     <div class="actions">
                       <button type="button" class="action-btn" data-acao="reparo">Reparo</button>
                       <button type="button" class="action-btn" data-acao="troca">Troca</button>
                       <button type="button" class="action-btn mic" title="Ditado por voz">üé§</button>
                     </div>
                     <div class="inputs">
                       <input type="number" class="qtd" placeholder="Qtd" value="1" min="0">
                       <input class="obs" placeholder="Observa√ß√µes">
                       <input type="number" class="val" placeholder="Valor" value="0" step="0.01">
                     </div>
                     </div>`;
      const buttons = c.querySelectorAll('.action-btn');
      buttons.forEach(b=>b.addEventListener('click', ()=>{
        if(b.classList.contains('mic')){
          startDictation(c.querySelector('.obs'));
          return;
        }
        const acao = b.getAttribute('data-acao');
        if(!acao) return;
        if(c.dataset.acao === acao){
          c.dataset.acao = '';
          c.classList.remove('selected','acao-reparo','acao-troca');
          buttons.forEach(btn=>btn.classList.remove('active'));
          c.querySelector('.inputs').style.display='none';
          setStatus(SYS, sub, comp, null);
          return;
        }
        c.dataset.acao = acao;
        buttons.forEach(btn=>btn.classList.toggle('active', btn === b));
        c.classList.add('selected');
        c.classList.remove('acao-reparo','acao-troca');
        c.classList.add(`acao-${acao}`);
        c.querySelector('.inputs').style.display='flex';
        const obs=c.querySelector('.obs').value;
        const val=parseFloat(c.querySelector('.val').value||0);
        const qtd=parseFloat(c.querySelector('.qtd').value||1);
        setStatus(SYS, sub, comp, acao, obs, val, qtd);
        updateSuggestions();
      }));
      ['input','change'].forEach(evt=>{
        ['.obs','.val','.qtd'].forEach(sel=>{
          c.querySelector(sel).addEventListener(evt, ()=>{
            if(!c.dataset.acao) return;
            const obs=c.querySelector('.obs').value;
            const val=parseFloat(c.querySelector('.val').value||0);
            const qtd=parseFloat(c.querySelector('.qtd').value||1);
            setStatus(SYS, sub, comp, c.dataset.acao, obs, val, qtd);
          });
        });
      });
      const saved = CHECKLIST[SYS]?.[sub]?.[comp];
      if(saved && saved.acao){
        c.dataset.acao = saved.acao;
        c.classList.add('selected');
        c.classList.add(`acao-${saved.acao}`);
        const inputs = c.querySelector('.inputs');
        inputs.style.display='flex';
        c.querySelector('.qtd').value = saved.qtd ?? 1;
        c.querySelector('.obs').value = saved.obs || '';
        c.querySelector('.val').value = saved.val ?? 0;
        buttons.forEach(btn=>{
          const ac = btn.getAttribute('data-acao');
          if(!ac) return;
          btn.classList.toggle('active', ac===saved.acao);
        });
      }
      compsBox.appendChild(c);
    });
  });
  applyFilterComp();
}

function setStatus(sys, sub, comp, acao, obs='', val=0, qtd=1){
  if(!acao){
    if(CHECKLIST[sys] && CHECKLIST[sys][sub]){
      delete CHECKLIST[sys][sub][comp];
      if(Object.keys(CHECKLIST[sys][sub]).length===0) delete CHECKLIST[sys][sub];
      if(Object.keys(CHECKLIST[sys]).length===0) delete CHECKLIST[sys];
    }
    return;
  }
  if(!CHECKLIST[sys]) CHECKLIST[sys] = {};
  if(!CHECKLIST[sys][sub]) CHECKLIST[sys][sub] = {};
  const entry = {
    acao,
    obs: obs || '',
    val: Number(val)||0,
    qtd: Number(qtd)||0
  };
  if(!isFinite(entry.val)) entry.val = 0;
  if(!isFinite(entry.qtd) || entry.qtd<=0) entry.qtd = 1;
  CHECKLIST[sys][sub][comp] = entry;
}

function sanitizeChecklist(){
  for(const sys in CHECKLIST){
    for(const sub in CHECKLIST[sys]){
      for(const comp in CHECKLIST[sys][sub]){
        const entry = CHECKLIST[sys][sub][comp];
        if(!entry){
          delete CHECKLIST[sys][sub][comp];
          continue;
        }
        if(!entry.acao && entry.status){
          if(entry.status === 'bad') entry.acao = 'troca';
          else if(entry.status === 'warn') entry.acao = 'reparo';
        }
        if(!entry.acao){
          delete CHECKLIST[sys][sub][comp];
          continue;
        }
        entry.obs = entry.obs || '';
        entry.val = Number(entry.val)||0;
        if(!isFinite(entry.val)) entry.val = 0;
        entry.qtd = Number(entry.qtd)||0;
        if(!isFinite(entry.qtd) || entry.qtd<=0) entry.qtd = 1;
      }
      if(!Object.keys(CHECKLIST[sys][sub]).length){
        delete CHECKLIST[sys][sub];
      }
    }
    if(!Object.keys(CHECKLIST[sys]||{}).length){
      delete CHECKLIST[sys];
    }
  }
}

function startDictation(input){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) return;
  const rec = new SR();
  rec.lang = 'pt-BR';
  rec.onresult = e=>{ input.value = e.results[0][0].transcript; };
  rec.start();
}

function updateSuggestions(){
  const sug=[];
  const freios = CHECKLIST['Freios'];
  if(freios){
    Object.values(freios).forEach(obj=>{
      Object.values(obj).forEach(it=>{ if(it.acao==='troca' || it.acao==='reparo') sug.push('Revisar pneus e rodas'); });
    });
  }
  const list=document.getElementById('sug-list');
  list.innerHTML = sug.map(s=>`<li>${s}</li>`).join('');
  document.getElementById('sugestoes').style.display = sug.length ? 'block' : 'none';
}

/* Filtros */
function applyFilterSub(){
  const q = (filtroSub.value||'').toLowerCase();
  [...subsBox.children].forEach(t=>{
    const match = t.getAttribute('data-sub').toLowerCase().includes(q);
    t.style.display = match ? '' : 'none';
  });
}
function applyFilterComp(){
  const q = (filtroComp.value||'').toLowerCase();
  [...compsBox.children].forEach(c=>{
    const txt = (c.getAttribute('data-comp')+' '+c.getAttribute('data-sub')).toLowerCase();
    c.style.display = txt.includes(q) ? '' : 'none';
  });
}
filtroSub.addEventListener('input', applyFilterSub);
filtroComp.addEventListener('input', applyFilterComp);

document.getElementById('btn-pdf').addEventListener('click', ()=>window.print());

function populateVehicleSelect(){
  const select = document.getElementById('f-placa');
  const base = ['<option value="">Selecione a placa</option>'];
  const sorted = [...VEHICLES].sort((a,b)=>String(a.placa||'').localeCompare(String(b.placa||''), 'pt-BR', {numeric:true}));
  sorted.forEach(v=>{
    const placa = String(v.placa||'').toUpperCase();
    const label = v.veiculo ? `${placa} - ${v.veiculo}` : placa;
    base.push(`<option value="${placa}">${label}</option>`);
  });
  select.innerHTML = base.join('');
}

function clearVehicleDetails(){
  CURRENT_VEHICLE = null;
  const ids = ['f-veiculo','f-ano-modelo','f-motorista'];
  ids.forEach(id=>{ const input = document.getElementById(id); if(input) input.value = ''; });
  document.getElementById('hist').innerHTML = '';
}

function applyVehicleDetails(vehicle){
  if(!vehicle){
    clearVehicleDetails();
    return;
  }
  const placa = String(vehicle.placa||'').toUpperCase();
  CURRENT_VEHICLE = {...vehicle, placa};
  document.getElementById('f-veiculo').value = vehicle.veiculo || '';
  const anoModelo = [vehicle.ano, vehicle.modelo].filter(Boolean).join(' / ');
  document.getElementById('f-ano-modelo').value = anoModelo;
  document.getElementById('f-motorista').value = [vehicle.motorista, vehicle.motorista2].filter(Boolean).join(' / ');
}

function updateVehicleHistory(placa){
  if(!placa){
    document.getElementById('hist').innerHTML = '';
    return;
  }
  google.script.run
    .withSuccessHandler(res=>{
      const historico = res?.historico || [];
      if(!historico.length){
        document.getElementById('hist').innerHTML = 'Sem OS anteriores para esta placa.';
        return;
      }
      const html = historico.map(h=>`<div>OS ${h.meta?.os||''} - ${(h.meta?.status||'').toUpperCase()}</div>`).join('');
      document.getElementById('hist').innerHTML = html;
    })
    .withFailureHandler(()=>{ document.getElementById('hist').innerHTML = ''; })
    .getVehicleHistory(placa);
}

function handleVehicleChange(){
  const select = document.getElementById('f-placa');
  const placa = String(select.value||'').toUpperCase();
  if(!placa){
    clearVehicleDetails();
    return;
  }
  let vehicle = VEHICLES.find(v=>String(v.placa||'').toUpperCase() === placa);
  if(!vehicle && CURRENT_VEHICLE && CURRENT_VEHICLE.placa === placa){
    vehicle = CURRENT_VEHICLE;
  }
  if(vehicle){
    applyVehicleDetails(vehicle);
  } else {
    applyVehicleDetails({placa});
  }
  updateVehicleHistory(placa);
}

function loadVehicles(){
  google.script.run
    .withSuccessHandler(list=>{
      VEHICLES = Array.isArray(list) ? list.map(v=>({ ...v, placa: String(v.placa||'').toUpperCase() })) : [];
      populateVehicleSelect();
      if(PENDING_VEHICLE_PLATE){
        document.getElementById('f-placa').value = PENDING_VEHICLE_PLATE;
        handleVehicleChange();
        PENDING_VEHICLE_PLATE = null;
      }
    })
    .withFailureHandler(err=>{
      console.error('Erro ao carregar ve√≠culos', err);
    })
    .getVehicles();
}

document.getElementById('f-placa').addEventListener('change', handleVehicleChange);

/* ======= Itens (linhas) ======= */
const itemsEl = document.getElementById('items');
function buildSelect(opts, placeholder="Selecione‚Ä¶"){ const s=document.createElement('select'); s.innerHTML=`<option value="">${placeholder}</option>`+opts.map(v=>`<option>${v}</option>`).join(''); return s; }
function fillSystems(sel){ sel.innerHTML = `<option value="">Selecione‚Ä¶</option>` + Object.keys(HIERARQUIA).map(k=>`<option>${k}</option>`).join(''); }
function createItemRow(prefill={}){
  const row = el('div',{class:'item-row'});
  const sSistema = el('select'); fillSystems(sSistema);
  const sSub = el('select'); sSub.innerHTML = `<option value="">Selecione‚Ä¶</option>`;
  const sComp = el('select'); sComp.innerHTML = `<option value="">Selecione‚Ä¶</option>`;
  const sTipo = buildSelect(['Servi√ßo','Pe√ßa'],'Tipo');
  const sServ = buildSelect(SERVICOS,'Servi√ßo');
  const iDesc = el('input',{placeholder:'Peculiaridade (lado, marca, observa√ß√µes...)'});
  const iQtd = el('input',{type:'number',step:'0.01', value: prefill.qtd ?? 1});
  const sUn = buildSelect(['UN','H','L','KG','KIT'],'Unid');
  const iPreco = el('input',{type:'number',step:'0.01', placeholder:'0,00'});
  const actions = el('div',{class:'item-actions'});
  const bDup = el('button',{class:'btn'},'Duplicar');
  const bDel = el('button',{class:'btn'},'Remover');
  actions.append(bDup,bDel);

  sSistema.addEventListener('change', ()=>{
    const sys = sSistema.value; sSub.innerHTML = `<option value="">Selecione‚Ä¶</option>`; sComp.innerHTML = `<option value="">Selecione‚Ä¶</option>`;
    if(!sys) return; Object.keys(HIERARQUIA[sys]).forEach(sub=>{ const o=document.createElement('option'); o.textContent=sub; sSub.appendChild(o); });
  });
  sSub.addEventListener('change', ()=>{
    const sys=sSistema.value, sub=sSub.value; sComp.innerHTML = `<option value="">Selecione‚Ä¶</option>`;
    if(!sys||!sub) return; HIERARQUIA[sys][sub].forEach(c=>{ const o=document.createElement('option'); o.textContent=c; sComp.appendChild(o); });
  });
  sTipo.addEventListener('change', ()=>{
    if(sTipo.value==='Pe√ßa' && !sServ.value) sServ.value='Troca/Substitui√ß√£o';
    sUn.value = (sTipo.value==='Servi√ßo') ? 'H' : 'UN';
  });
  [iQtd,iPreco,sTipo].forEach(elm=> elm.addEventListener('input', updateTotals));
  bDel.addEventListener('click', ()=>{ row.remove(); updateTotals(); });
  bDup.addEventListener('click', ()=>{ itemsEl.insertBefore(createItemRow(getRowData(row)), row.nextSibling); updateTotals(); });

  // Prefill
  if(prefill.sistema){ sSistema.value=prefill.sistema; sSistema.dispatchEvent(new Event('change')); }
  if(prefill.sub){ sSub.value=prefill.sub; sSub.dispatchEvent(new Event('change')); }
  if(prefill.comp){ sComp.value=prefill.comp; }
  if(prefill.tipo){ sTipo.value=prefill.tipo; sTipo.dispatchEvent(new Event('change')); }
  if(prefill.serv){ sServ.value=prefill.serv; }
  if(prefill.desc){ iDesc.value=prefill.desc; }
  if(typeof prefill.preco!=='undefined'){ iPreco.value=prefill.preco; }
  if(prefill.un){ sUn.value=prefill.un; }

  row.append(sSistema,sSub,sComp,sTipo,sServ,iDesc,iQtd,sUn,iPreco,actions);
  return row;
}
function getRowData(row){
  const [sistema, sub, comp, tipo, serv, desc, qtd, un, preco] = [...row.children].slice(0,9).map(el=> el.value);
  return {sistema, sub, comp, tipo, serv, desc, qtd:Number(qtd||0), un, preco:Number(String(preco).replace(',','.'))};
}
function updateTotals(){
  let tp=0, ts=0;
  [...itemsEl.children].forEach(row=>{
    const {tipo,qtd,preco} = getRowData(row);
    const line = (qtd||0)*(preco||0);
    if(tipo==='Pe√ßa') tp+=line; else ts+=line;
  });
  const acresc = toNumber(document.getElementById('t-acresc'));
  const geral = tp + ts + acresc;
  document.getElementById('t-pecas').textContent = fmtBRL(tp);
  document.getElementById('t-serv').textContent  = fmtBRL(ts);
  document.getElementById('t-geral').textContent = fmtBRL(geral);
}
document.getElementById('t-acresc').addEventListener('input', updateTotals);
document.getElementById('btn-add').addEventListener('click', ()=>{ itemsEl.appendChild(createItemRow()); updateTotals(); });

/* ======= Adi√ß√£o em lote ======= */
document.getElementById('btn-add-batch').addEventListener('click', ()=>{
  const ativos = [...compsBox.querySelectorAll('.comp')].filter(c=>c.dataset.acao);
  if(!ativos.length) return;
  ativos.forEach(c=>{
    const sys = c.getAttribute('data-sys') || SYS;
    const sub = c.getAttribute('data-sub');
    const comp = c.getAttribute('data-comp');
    const acao = c.dataset.acao || 'troca';
    const tipo = acao==='troca' ? 'Pe√ßa' : 'Servi√ßo';
    const serv = acao==='troca' ? 'Troca/Substitui√ß√£o' : 'Reparo/Recondicionamento';
    const desc = c.querySelector('.obs').value;
    const qtd  = parseFloat(c.querySelector('.qtd').value || '1');
    const preco= parseFloat(c.querySelector('.val').value || '0');
    const un   = acao==='troca' ? 'UN' : 'H';
    const base = { sistema:sys, sub, comp, tipo, serv, desc, qtd, un, preco };
    itemsEl.appendChild(createItemRow(base));
  });
  updateTotals();
  document.getElementById('itemsCard').style.display='block';
});

/* ======= Exportar / Salvar / Carregar ======= */
function getRows(){ return [...itemsEl.children].map(getRowData); }
function download(filename, text, mime='text/plain'){ const blob=new Blob([text],{type:mime}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0); }
document.getElementById('btn-export').addEventListener('click', ()=>{
  const head = ["Sistema","SubSistema","Componente","Tipo","Servi√ßo","Descri√ß√£o","Qtd","Un","Pre√ßo"];
  const lines = [head.join(';')].concat(getRows().map(it=>[
    it.sistema||'', it.sub||'', it.comp||'', it.tipo||'', it.serv||'',
    (it.desc||'').replace(/;/g,','), it.qtd||0, it.un||'', (it.preco||0)
  ].join(';')));
  download(`OS_${document.getElementById('f-os').value||'itens'}.csv`, lines.join('\n'), 'text/csv;charset=utf-8;');
});
document.getElementById('btn-export-hier').addEventListener('click', ()=>{
  download('hierarquia.json', JSON.stringify(HIERARQUIA, null, 2), 'application/json');
});
const fileHier = document.getElementById('file-hier');
document.getElementById('btn-import-hier').addEventListener('click', ()=> fileHier.click());
fileHier.addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    try{
      const data = JSON.parse(ev.target.result);
      if(!data || typeof data !== 'object') throw new Error('JSON inv√°lido');
      Object.keys(HIERARQUIA).forEach(k=>delete HIERARQUIA[k]);
      Object.assign(HIERARQUIA, data);
      SYS = null;
      SUBS.clear();
      renderSistemas();
      renderSubSistemas();
      renderComponentes();
      alert('Hierarquia importada!');
    }catch(err){
      alert('Erro ao importar: '+err.message);
    }
  };
  reader.readAsText(f);
  e.target.value='';
});
function buildPayload(){
  const placa = String(document.getElementById('f-placa').value||'').toUpperCase();
  const veiculo = CURRENT_VEHICLE ? {...CURRENT_VEHICLE} : {};
  if(placa) veiculo.placa = placa;
  const entradaEl = document.getElementById('f-data-entrada');
  const entradaIso = entradaEl?.dataset?.iso || '';
  const entradaDisplay = entradaEl?.value || '';
  const oficina = document.getElementById('f-resp').value || '';
  return {
    meta:{
      os: document.getElementById('f-os').value,
      entrada: entradaIso || entradaDisplay,
      entradaDisplay,
      oficina,
      resp: oficina,
      status: CURRENT_STATUS
    },
    veiculo,
    checklist: CHECKLIST,
    itens:getRows(),
    totais:{ pecas:document.getElementById('t-pecas').textContent, serv:document.getElementById('t-serv').textContent, acresc:Number(document.getElementById('t-acresc').value||0), geral:document.getElementById('t-geral').textContent }
  };
}
function saveChecklist(msg='Dados salvos!'){
  const payload = buildPayload();
  google.script.run
    .withSuccessHandler(()=>alert(msg))
    .withFailureHandler(err=>alert('Erro ao salvar: '+err.message))
    .saveOS(payload);
}
document.getElementById('btn-save').addEventListener('click', ()=>saveChecklist('Dados salvos!'));
document.getElementById('btn-finalizar').addEventListener('click', ()=>saveChecklist('Checklist finalizado!'));

function applyData(data){
  document.getElementById('f-os').value = data?.meta?.os || '';
  const entradaRaw = data?.meta?.entrada || '';
  const entradaDisplay = data?.meta?.entradaDisplay || data?.meta?.entradaFmt || '';
  setEntrada(entradaRaw, entradaDisplay);
  document.getElementById('f-resp').value = data?.meta?.oficina ?? data?.meta?.resp ?? '';
  CURRENT_STATUS = data?.meta?.status || 'Aberta';
  const veiculoData = data?.veiculo || {};
  const placa = veiculoData?.placa ? String(veiculoData.placa).toUpperCase() : '';
  CURRENT_VEHICLE = placa ? {...veiculoData, placa} : null;
  if(placa){
    document.getElementById('f-placa').value = placa;
    if(VEHICLES.length){
      handleVehicleChange();
    }else{
      applyVehicleDetails(CURRENT_VEHICLE);
      updateVehicleHistory(placa);
      PENDING_VEHICLE_PLATE = placa;
    }
  }else{
    document.getElementById('f-placa').value = '';
    clearVehicleDetails();
  }
  itemsEl.innerHTML = '';
  (data?.itens||[]).forEach(it => itemsEl.appendChild(createItemRow(it)));
  document.getElementById('itemsCard').style.display = (data?.itens?.length) ? 'block' : 'none';
  document.getElementById('t-acresc').value = data?.totais?.acresc ?? 0;
  Object.keys(CHECKLIST).forEach(k=>delete CHECKLIST[k]);
  Object.assign(CHECKLIST, data?.checklist || {});
  sanitizeChecklist();
  updateTotals();
  updateSuggestions();
}

document.getElementById('btn-load').addEventListener('click', ()=>{
  const os = prompt('N√∫mero da OS a carregar:');
  if(!os) return;
  google.script.run
    .withSuccessHandler(res=>{ if(res) applyData(res); else alert('OS n√£o encontrada'); })
    .withFailureHandler(err=>alert('Erro ao carregar: '+err.message))
    .loadOS(os);
});

function startNewOS(){
  google.script.run.withSuccessHandler(num=>{
    document.getElementById('f-os').value = num;
  }).getNextOS();
  setEntradaNow();
  CURRENT_STATUS = 'Aberta';
  document.getElementById('f-resp').value = '';
  document.getElementById('f-placa').value = '';
  PENDING_VEHICLE_PLATE = null;
  clearVehicleDetails();
  itemsEl.innerHTML = '';
  document.getElementById('itemsCard').style.display = 'none';
  document.getElementById('t-acresc').value = 0;
  Object.keys(CHECKLIST).forEach(k=>delete CHECKLIST[k]);
  updateTotals();
  updateSuggestions();
}

/* start */
renderSistemas();
loadVehicles();
startNewOS();
</script>
</body>
</html>
